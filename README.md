# [Russian] GIF/AnimatedWEBP/WEBP/SVG/other Image Viewer v0.9 for Windows by Sergei Krumas

Image Viewer я написал на замену почившей в 2015м году Picasa Photo Viewer. Как и с Oxxxy Screenshoter, кое-что взято за основу и поверх наворочено куча отсебятины.
- 11 февраля 2022 - начата разработка
- 28 марта 2022 - начато активное использование
- 30 мая 2022 - готова полноценная альфа-версия
- 1 июня 2022 - начаты бета-тесты и допиливания до релизной версии
    - декабрь 2022 - апрель 2023 - первый раунд

## Changelog

### 1й раунд (декабрь 2022 - апрель 2023)
- дефолтная превьюшка теперь может быть полностью прозрачной. Об этом добавлена соответствующая настройка
- теперь программа сворачивается в трей, когда окно закрывается. Сделано это для того, чтобы при запуске не пришлось долго ожидать загрузки библиотеки
- в меню трея программа выводит статистику сожранной памяти
- оконки у панели управления теперь расположены на затенённом фоне, что облегчит их нахождение
- перерисованы кнопки увеличения и уменьшения масштаба на панели управления
- доработка isolated mode:
    - теперь работает не только для папки, но и для текущй картинки и доступно через контекстное меню
    - окно новой копии программы в isolated mode открывается на другом мониторе по возможности
- в контесное меню превьюшек добавлена опция сканирования в глубину. При сканировании в глубину будут добавлены не только изображения в текущей папке, но и в её подпапках тоже. Опция сохраняется в файле сессии и даёт эффект при первоначальной загрузке и при принудительном обновлении папки
- приложение научилось определять когда оно запускается из Sublime Text
- добавлена история просмотра картинок
    - сверху идёт второй ряд мелких превьшек, отображающий историю просмотра
    - стрелка + Alt для возвращения к предыдущей показанной картинке
    - история может быть либо для одной папки, либо для всех сразу, есть соотвествующая настройка
    - при достижении краёв списка истории выдаётся сообщение
- выполнен рефакторинг многих частей программы
    - settings api
    - разнёс код из главного файла по другим новым файлам
    - отрисовка мелких превьюшек
    - код сокетов
    - QMovie переписан, чтобы анимированный контент отображался не через костыльный QLabel, а через отрисовку, как это делает весь статический контент
- сделана подцветка центрального лейбла в стиле начала глав Half Life 2, чтобы можно было визуально заметить, что сообщение через лейбл появляется раз за разом
- добавлена настройка для размера превьюшек во вьювере
- теперь изображения стремятся занять максимально возможное пространство благодаря использованию функции fit
- нарисована иконка по подобию Chromium. Потом ещё раз её перерисую
- в левом верхнем углу для оталки выводится инфа из стандартного выхода, вывод можно отключить в настройках
- теперь если клавиша перелистывания изображений зажата, то отменяется анимация, которая в таком случае замедляет перелистывание. Вдобавок вообще для любого значения пропускается интерполяция, если начальные и конечные значения совпадают, в итоге опять же избавляемся от задержки
- нажатие на Esc сначала закрывает окно с настройками, если оно открыто, и только при повторном нажатии закрывается само приложение
- добавлена настройка для запуска в трей, при чём в таком случае окно не показывается сразу, а только после клика по иконке трея. При клике показывается окно со стартовой заглушкой, которая приглашает к выбору папки для просмотра.
- в настройках перереработан вид чекеров, теперь ясно видно, что отключено, а что включено
- повороты теперь реализованы за счёт поворота самой картинки в памяти, а не за счёт поворота холста
- переработана функция кадрирования, доступная через клавишу R или R+Shift. Под эту функцию в настройках добавлена строка для пути, по которому будут сохраняться кадрированные изображения. Зажатие Ctrl даст сбросить текущий путь и задать новый
- прога теперь показывает метадату во вьюпорте, если она есть в файле изображения, в настройках есть соответствующая галочка
- появился скролл в режиме библиотеки для каждой колонки и отрисовка скроллбаров
- кадрирование теперь может сохранять картинки из анимационний
- теперь можно выделять прямоугольником область интереса на изображении и добавлять к ней комментарий
- доработан UX просмотра анимированного контента
    - при перелистывании запоминается стояла ли анимация на паузе или нет
    - более удобная покадровая прокрутка через зажатую левую кнопку мыши
- появилась возможность растягивания программы на два монитора в режим библиотеки, чтобы левый столбец был на первом мониторе, а правый столбец был на втором
- появилась возможность мигрировать с монитора на монитор с помощью Ctrl+стрелка
- по просьбе добавлена визуальная фича для антуража, которая делит пространство на квадраты, прозрачность которых плавно рандомно меняется как в загрузочной заставке Splinter Cell Black list. Любой такой квадрат будет возвращаться к нормальному отображению, если над ним находится курсор мыши
- теперь при открытии приложения для конкретной папки или для конкретного изображения будет спрашиваться открыть окно в изолированном режиме или в нормальном, где много времени уходит на сканирование папок добавленных в библиотеку перед непосредственным открытием окна
- коменты отключены в изолированном режиме


### 2й раунд (май 2023 - ??????? 2023)
- стартовый диалог теперь имеет третью опцию — «Закрыть». Она позволяет вообще не запускать программу. Клик по крестику в углу делает то же самое
- теперь svg-файлы (расширения `.svg`, `.svgz`) растеризуются в приемлемом разрешении, которое можно изменять через пункт контестного меню «Изменить разрешение растеризации SVG-файла»
- добавлена настройка «Запускать упрощённый режим сразу и без диалога»
    - это позволяет пропускать диалог выбора режима упрощённый или библиотечный (расширенный)
    - перезапуститься можно в расширенном режиме через команду контекстного меню
- в контестное меню добавлена команда «Перезапуск» для сброса лишней памяти
    - если была открыта библиотека, то при перезапуске тоже будет открыта библиотека 
- в файл `history.log` в папке программы теперь прописывается все запросы к приложению с датой и путём до запрашиваемых картинки или папки
- UX: теперь активация Scroll Lock через одноимённую клавишу переносит функционал клавиш WASD на клавиши со стрелками
- В контекстном меню появилась команда **Свернуть**
- !!!! обнаружен баг: после предварительного сворачивания через сочетание Win+Key Down при разворачивании кликом мышки по панели задач адекватно не появляется рамка у окна. Решения пока найти не удалось. Попытки решить прописаны в методе changeEvent. Код в changeEvent на данный момент вызывает бесконечный цикл баги даже в окнах других приложенийы
- исправлен баг с залипанием нажатой левой клавиши при переходе окна в режим "с рамкой"



## Читаемые форматы файлов
- .webp (анимированные и статические)
- .gif
- .jpg/.jpeg
- .jfif
- .png
- .tif/.tiff
- .tga
- .svg/.svgz
- .ico
- .bmp
Подробности можно узнать в коде статического метода `is_interest_file`.

## Написать про краши

## Дальнейшие планы
- повысить производительность приложения
- ввести систему тегирования изображений
- показывать превьюшки для других файлов в папке отличных от изображений
- добавить возможность менять местами превьюшки через пететаскивание по одной или несколько в библиотеке и во вьювере
- реализовать клон программы PureRef и внедрить его через отдельный режим (на примере режима библиотеки) + внедрить модуль Oxxxy
- добавить возможность оставлять пометки с помощью модуля Oxxxy, запоминать их и отображать при повторном открытии
- автоматическая ассоциация с файлами изображений через реестр Windows

## Иконка
Идея для иконки позаимствована от иконки браузера Chromium, а цвета для неё взяты из иконки самой Picassa Photo Viewer.
![](docs/icon.png)

## Важно
Из-за GIL в Си-шной реализации Python потоки QThread не работают так, как теоретически задумано, т.е. они выполняются по очереди, а не параллельно. Код обработки данных, например создания превьюшек, с какого-то момента стал писаться исходя из того, что потоки выполняются по очереди, поэтому в реальном многопоточном режиме могут появиться сбои и баги. Имейте это ввиду.

## Программа рукопашного тестирования Oxxxy перед релизом
Ниже представлена инфа для проверки программы перед релизом, которого ещё не было. Здесь все очень сумбурно описано и я боюсь, что контекст некоторых моментов недостаточно раскрыт для понимания со стороны. Поэтому что есть, есть, вас предупредили.

- общее
    - вьювер должен нормально открываться на втором мониторе
    - красные кнопки закрытия и библиотеки
    - по центру должен выводиться информационный лейбл
        - надо прятать этот лейбл, если перелеснули на другую картинку
    - система устранения дубликатов программы через сокеты
    - появление картинки
        - картинка должна позиционироваться по центру
    - предувеличение или предуменьшение
        - слишком большие картинки надо уменьшать по масштабу при подготовке перед показом до размеров, которые вместяться на экран
        - для слишком маленьких картинок нужно делать предувеличение
          - орииентироваться либо на ширину, либо на высоту
          - учитывать что картинки могут быть вытянуты по ширине или длине
    - сообщения
        - если в избранном нет ни одного файла при переключении на просмотр
          - выводить сообщение
        - если нет ни одной папки кроме избранного
          - выводить сообщение

- проверка на баги
    - сильно приближаться ко краям и углам картинки. Не должно быть отскока
    - анимиованные картинки должны нормально отрабатывать переход между оконным и полноэкранными режимами
    - повороты картинки на фиксированные значения
        - повороты не должны работать на анимированном контенте
    - миниатюрки для изображения
        - отдельный тред для создания
        - отрисовка
            - отражение миниатюрок внизу
        - смещение миниатюр при перелистывании так, чтобы выбранная картинка была по центру
        - при клике на картинку она должна быть выбрана
        - это должно правильно работать на всех мониторах
    - причина краша обязательно выводится в файл
    - прога должна пытаться открыть неоткрываемый файл через попытку его конвертации в PIL
    - проблемы со скейлом при переходе из библиотеки в просмоторщик
    - при перетаскивании фотки нельзя чтобы курсор определял прозрачность панели миниатюр
    - при масштабировании картинок через клаву тоже должно отображаться текущее значение масштаба
    - если курсор мыши за пределами картинки, то картинка должна скейлится относительно ЦЕНТРА ОКНА
    - под прозрачными png должен рисоваться шахматный фон, иначе всё будет прокликливаться
        - хотя походу это проблема именно режимов отрисовки, и в итоге альфа окна не должна быть испорчена альфой картинки
    - удаление из избранного последнего файла не долджно крашить прогу
    - у красных угловых кнопок курсор должен меняться на указательный палец
    - должен читаться jfif-формат
    - программа должна без сбоя принимать запросы на открытие файлов через несколько часов после запуска этой программы
    - на анимированном контенте тоже должны отрисовываться
        - трети
        - точка
    - должно появляться сообщение "невозможно отобразить" вместе с трейсбэком
    - если удаляется папка, то нужно остановить поток, который делает ей превьюшки, если он работает
    - при удалении большого числа папок из библиотеки в режиме библиотеки отключается скролл, не работает
    - введение id-шников для таймеров, чтобы при наличии таймера по текущему
        id была вызвана завершающая фунция и таймер был выключен
            БАГ РЕШЁН ЗА СЧЁТ БЛОКИРОВКИ ФУНКЦИЙ на время анимации
      - надо курсор менять когда окно настроек открыто
    - трети должны вращаться вместе с изображением
    - элементы из левой части библиотеки должны быть кликабельными
    - при листании папок в библиотеке не должны выставляться картинки в просмоторщике - это тормозит листание
    - фотки с фотика должны грузится с правильной ориентацией
    - при удалении картинки из избранного или из списка нужно обновлять колонки для правой части библиотеки
    - проверить случай когда папка с избранным будет пустая и на неё произойдёт переключение
    - нижняя панель упраления с кнопками
        - должна реагировать на изменение главного окна - т.е, адаптироваться по размеру и центрироваться заново
        - должна реагировать на приближение мышки
    - масштаб анимированных объектов начинает глючить после того как даблкликом переводишь его несколько раз туда-сюда обратно
    - сообщения в случае ненайденной картинки должны выводится в нормальном масштабе, а не в том масштабе, который был выставлен у удалённой картинки
    - сочетания должны работать независимо от языка клавиатуры, для этого надо работать со сканкодами
    - внизу в области миниатюр мышка почему-то не реагирует на превьюшки в режиме библиотеки
    - центральный лейбл должен исчезать когда идёт перелистывание на другую картинку
    - функция в настройках для прятания окна в трей при закрытии

- юзабилити
    - при повороте не должно случиться такого, что картинка полностью вывалиться из вида.
      - такое может получится, если очень сильно приблизил картинку и повернул
      можно чуть уменьшить по габаритам прямоугольник окна и проверять не пересекается ли он с прямоугольником изображения.
      И если да, То надо будет как-то втянуть картинку ближе к центру.
        Наверное, нужно сделать это так - перенести картинку на разницу между ближайшим из углов и центром окна
    - когда упрёшься в конец или в начало списка, то надо показывать панель управления
    - в библиотеке количество колонок должно динамически изменятся при изменени размера окна
    - превьюшки должны создаваться только после показа главной картинки
    - превьюшка не должна выделяться, если я кликаю по управляющим кнопкам в области пересечения превьюшки и управляющей кнопки

- наставления
    - код, пишущий в файлы сессии и избранное
        не должен содержать циклов внутри контекстного менеджера файла

- анимационные эффекты
    - easeOut при закрытии программы
    - easeOut при открытии программы

- эффективность
    - при обновлении папок надо брать уже имеющиеся превьюшки из имеющегося списка, а не просто его отчищать
      - проверять изменился ли файл надо по хэшу или пути!
      - это пригодится при обновлении больших папок

- функционал
    - клавиша esc должна закрывать аппликуху
    - перемещать картинку можно не только с помощью стрелок, но и с помощью WASD
        - работает вместе с модификатором Shift
    - взаимодействие с картинкой
        - перемещение картинки через левую кнопку мыши
        - увеличение-уменьшение картинки через колесо мыши
            - масштабирование и перемещение главной картинки в зависимости от положения курсора
                - наименьший масштаб - 1%
                - максимальный масштаб 10 000%
        - даблклик по картинке, которая утащена из центра и не в нативном масштабе - сразу летит в центр и масштаб её сбрасывается
            Если картинка уже в центре, то она увеличивается до размеров, чтобы занимать вообще всю доступную площадь минус площадь панели и миниатюрами
    - управление воспроизведением анимированной картинки
        - вместо активного прогресс-бара используется колесо мыши + Shift
        - на пробел воспроизведение и оставновка
        - задать скорость - Shift+Ctrl+колесо мыши
    - Tab для входа в и выхода из режима библиотеки
    - режим библиотеки
        - стрелки вверх и вниз для переключения между папками в библиотеке
    - режим слайдшоу
      - непременное завершение сладшоу после того как
         окно/приложение становится неактивным/теряет фокус
         нажаты любые клавиши
    - должна быть иконка в трее
    - добавление и удаление из избранного
    - в режиме библиотеки мышка не должна скейлить или перемещать картинку и курсор не должен менятся
    - сортировка по дате и по имени в обоих направлениях
        - через меню по миниатюрам
        - меню сортировки показывает какая сортировка в данныйо момент применена
    - функция кадрирования
        - Shift + R - сделать в масштабе окна
        - R - сделать в масштабе ихсодной картинки
    - клавиша F - удаление и добавление из и в избранное
    - всплывающее окно с настройками
    - функция отражения по горизонтали через клавишу M
    - смена курсоров
        - над картинкой
        - при перетаскивании
        - над кнопками
        - в библиотеке над превьюшками должен быть нормальный курсор
    - работа с буфером обмена
        - копирование неанимированного изображения в буфер обмена
        - копирование из буфера обмена в текущую картинку
    - клавиша T должна переключать трети
    - клавиша Y должна следить за переключением режима окна
    - Shift+Tab - переключение папок без захода в Tab-панель
    - показывать вселенские истины при сильном увеличении
    - должен создаваться файл krumassan.ini для запоминания поворота картинок
    - перелистывание картинок через клавиши Влево и Вправо
        - также через мышку с зажатым Ctrl
    - клавиша Вверх и Вниз управляют масштабом
    - поддержка анимированных GIF и WEBP
        - пассивный прогрессбар для анимации
        - различать статические webp от анимированных webp
    - задавать заголовок окна в зависимости от файла открытого при перелистывании и при открытии
    - для каждой открытой папки (или картинки всё-таки?) запоминаются скейл и расположение картинки
    - при вызове должно появляться контестное меню для картинки и для панели управления
        - для элементов из избранного
          - пункт в контексном меню - "открыть папку, что содержит эту пикчу"
    - созранение и загрузка сессий открытых файлов
        - в сохранённой сессии открытых папок надо запоминать текущую открытую картинку для каждой папки
    - нормально отрабатывать переход из полноэкранного режима в оконный и обратно
        - в неполноэкранный режим можно войти, если кликнуть на прозрачную область за пределы изображения
        - в полноэкранный режим входим через двойной клик на изображении
        - проверить на втором экране
        - проверить на адекватность всё
        - нужно так же менять относительную позицию картинки, чтобы визуально она оставалась на месте
    - F1 - актуальная справка
    - генерация превьюшек
        - тред создания превьюшек не должен быть запущен для конкретной папки ещё раз, если он УЖЕ запущен по какой-то папке
            - инфа о запущенных тредах показывается сбоку
    - двойной клик из библиотеки на папке переключает обратно в просмоторщик
    - библиотека
        - превьшки должны появляться в левой части при наведении на них указателя
    - клавиши Home и End переключают к начальной и конечной пикче списка соответственно
    - открывать файлы и папки перетаскиванием их в окно
    - клавиша Delete для удаления картинок в корзину и из списка
          - когда удалишь все картинки, то переключение пойдёт на библиотеку и будет выбрана другая папка
                  а ту папку скорее всего надо будет удалить
          - показывать сообщение через центральный всплывающий лейбл
    - при переходе из библиотеки в просмоторщик должна высвечиваться надпись "загрузка"
    - режим увеличения через задание интересующей области с помощью Ctrl - Region Zoom In
        - смена курсора над изображением во время зажатия Ctrl
        - отменяется через клавишу ESC восстанавливая масштаб и позицию
    - способность отделятся в дубликат
        - кнопка "открыть папку в копии приложения" в библиотеке
        - без прослушивающего сервера
        - без сброса аргумента в файл для сервера
        - менять иконку
            - для обычных иконка будет PV
            - для отделившихся иконка будет в виде P
        - не создавать иконку в трее

- проверка на баги стартовой плашки
    - если вьювер уже открыт и ему подают ссылку на несуществующую картинку,
        то он зависает на надписи "загрузка"
    - проверить на открытие заведомо битого файла, единственного в папке
    - проверить на открытие заведомо несуществующего файла, где вообще нет изображений
- общая проверка на баги
    - нижний элемент в столбце папок должен прокликиваться
    - при потере фокуса окном панель управления может залипать на одном уровне прозрачности и не отлипать обратно
    - при переключении из полноэкранного режима в оконный неправильно работает прокрутка списка папок в левом столбце
    - прога не должна выводить ошибок при выделении нескольких картинок и последующем нажатии Enter
